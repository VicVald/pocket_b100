upstream fastapi {
    server web:8000;
}

server {
    listen 80;
    server_name _;

    # Servir React (SPA)
    location / {
        root /usr/share/nginx/html;
        # Try the requested file, then directory, then fall back to index.html.
        # Adding $uri/ and a =404 fallback prevents an internal redirection
        # cycle when index.html is missing or not accessible.
        try_files $uri $uri/ /index.html =404;
    }

    # Servir estáticos do React (assets estão em /usr/share/nginx/html/assets)
    # Use `root` behavior or alias to the actual assets directory so
    # requests like /assets/index-BKJg4nlK.js map to
    # /usr/share/nginx/html/assets/index-BKJg4nlK.js
    location /assets/ {
        alias /usr/share/nginx/html/assets/;
        # Let nginx set correct MIME types
        try_files $uri $uri/ =404;
    }

    # Proxy para Fast API
    location /api/ {
        proxy_pass http://fastapi;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }

    # Serve index.html directly (avoid re-processing by the `location /` block)
    # Keep this inside the server block so the config is valid.
    location = /index.html {
        root /usr/share/nginx/html;
    }

}